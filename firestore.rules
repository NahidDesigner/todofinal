rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isAdmin() { return signedIn() && request.auth.token.role == 'admin'; }
    function isSelf(uid) { return signedIn() && request.auth.uid == uid; }

    // Users and subcollections
    match /users/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid) || isAdmin();
      allow update: if isSelf(uid) || isAdmin();
      allow delete: if isAdmin();

      // Notifications
      match /notifications/{nid} {
        allow read, list: if isSelf(uid) || isAdmin();
        // Created by server; allow user to update status to 'read'
        allow create: if isAdmin(); // server-side via Admin SDK
        allow update: if isSelf(uid);
        allow delete: if isSelf(uid) || isAdmin();
      }

      // Learning logs
      match /learning/{dateId} {
        allow read, list: if isSelf(uid) || isAdmin();
        allow create, update, delete: if isSelf(uid) || isAdmin();
      }
    }

    // Tasks (top-level)
    match /tasks/{taskId} {
      // Readable to owner, assignee, or admin
      allow read: if signedIn() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.isAssigned == true && resource.data.assignedToId == request.auth.uid) ||
        isAdmin()
      );

      // Create:
      // - personal: owner == auth.uid && !isAssigned
      // - assigned: only admin may create with isAssigned == true
      allow create: if signedIn() && (
        (!request.resource.data.isAssigned && request.resource.data.ownerId == request.auth.uid) ||
        (isAdmin() && request.resource.data.isAssigned == true)
      );

      // Update:
      // - personal: owner may update
      // - assigned: only admin may update directly; assignee must use callable Function
      allow update: if signedIn() && (
        (!resource.data.isAssigned && resource.data.ownerId == request.auth.uid) ||
        isAdmin()
      );

      // Delete:
      // - personal: owner may delete
      // - assigned: only admin may delete
      allow delete: if signedIn() && (
        (!resource.data.isAssigned && resource.data.ownerId == request.auth.uid) ||
        isAdmin()
      );
    }
  }
}